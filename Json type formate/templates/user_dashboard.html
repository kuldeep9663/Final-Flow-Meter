<!DOCTYPE html>
<html lang="en">
<head>
<title>User Modem Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
    --sidebar-width:250px;
    --sidebar-collapsed:72px;
    --dark:#020617;
    --main:#0f172a;
    --accent:#38bdf8;
}
body{
    margin:0;
    background:var(--main);
    color:#e5e7eb;
    font-family:Arial,sans-serif;
    margin-left:var(--sidebar-width);
    transition:margin-left .3s ease;
}
body.collapsed{ margin-left:var(--sidebar-collapsed); }
@media(max-width:768px){ body{ margin-left:0; } }

.sidebar{
    position:fixed;
    top:0;left:0;
    width:var(--sidebar-width);
    height:100vh;
    background:var(--dark);
    padding:20px 14px;
    box-shadow:2px 0 20px rgba(0,0,0,.6);
    transition:.3s;
    z-index:1000;
}
.sidebar.collapsed{ width:var(--sidebar-collapsed); }
.sidebar.hidden{ transform:translateX(-100%); }

.brand{
    color:var(--accent);
    font-size:20px;
    font-weight:bold;
    text-align:center;
    margin-bottom:30px;
}
.sidebar.collapsed .brand{ display:none; }

.menu a{
    display:flex;
    align-items:center;
    gap:14px;
    padding:12px;
    border-radius:10px;
    text-decoration:none;
    color:#e5e7eb;
    font-weight:600;
}
.menu a:hover{ background:#1e293b;color:var(--accent); }
.icon{ width:22px;text-align:center; }
.sidebar.collapsed span{ display:none; }

.main{ padding:20px; }

.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:20px;
}
.toggle-btn{
    background:#020617;
    color:#38bdf8;
    border:none;
    font-size:22px;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
}
h1{ margin:0;color:#38bdf8;font-size:22px; }

.user-box{
    display:flex;
    gap:12px;
    background:#020617;
    padding:8px 14px;
    border-radius:10px;
}
.logout{
    background:#ef4444;
    color:#fff;
    padding:6px 12px;
    border-radius:6px;
    text-decoration:none;
    font-size:14px;
    font-weight:bold;
}

.summary{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:16px;
    margin-bottom:25px;
}
.summary-card{
    background:#020617;
    padding:16px;
    border-radius:12px;
    text-align:center;
    box-shadow:0 0 10px #000;
}
.total{color:#38bdf8}
.online{color:#22c55e}
.offline{color:#ef4444}

.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:16px;
}
.card{
    background:#020617;
    border-radius:12px;
    padding:16px;
    box-shadow:0 0 12px #000;
}
.imei{ color:#38bdf8;font-size:18px;font-weight:bold; }
.status{ display:flex;align-items:center;gap:10px;margin:10px 0; }
.dot{ width:14px;height:14px;border-radius:50%; }
.dot.online{ background:#22c55e; }
.dot.offline{ background:#ef4444; }
.last{ font-size:13px;opacity:.7; }
.actions{ display:flex;gap:10px;margin-top:12px; }
.btn{
    flex:1;
    padding:8px;
    border-radius:8px;
    text-decoration:none;
    font-weight:bold;
    font-size:14px;
    text-align:center;
}
.logs{ background:#22c55e;color:#020617; }
</style>
</head>

<body>

{% set ns = namespace(total=0, online=0, offline=0) %}

<div class="sidebar" id="sidebar">
    <div class="brand">üì° NB-IoT</div>
    <nav class="menu">
        <a href="/user-dashboard"><div class="icon">üè†</div><span>Dashboard</span></a>
        <a href="/user-report">üìä Report</a>
        <a href="/logout"><div class="icon">üö™</div><span>Logout</span></a>
    </nav>
</div>

<div class="main">
<button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>

<div class="header">
    <h1>üì° My Modems</h1>
    <div class="user-box">
        <span>üë§ {{ session.username }}</span>
        <a class="logout" href="/logout">Logout</a>
    </div>
</div>

{# ===== COUNT MODEMS CORRECTLY ===== #}
{% for site, modems in dashboard.items() %}
    {% for m in modems %}
        {% set ns.total = ns.total + 1 %}
        {% if m.status == "ONLINE" %}
            {% set ns.online = ns.online + 1 %}
        {% else %}
            {% set ns.offline = ns.offline + 1 %}
        {% endif %}
    {% endfor %}
{% endfor %}

<div class="summary">
    <div class="summary-card">
        <h2 class="total">{{ ns.total }}</h2>
        <p>Total Modems</p>
    </div>
    <div class="summary-card">
        <h2 class="online">{{ ns.online }}</h2>
        <p>Online Modems</p>
    </div>
    <div class="summary-card">
        <h2 class="offline">{{ ns.offline }}</h2>
        <p>Offline Modems</p>
    </div>
</div>

<div class="grid">
{% if ns.total == 0 %}
    <p>No modems assigned.</p>
{% endif %}

{% for site, modems in dashboard.items() %}
    {% for m in modems %}
    <div class="card">
        <div class="imei">{{ m.imei }}</div>
        <div class="status">
            <div class="dot {{ 'online' if m.status=='ONLINE' else 'offline' }}"></div>
            {{ m.status }}
        </div>
        <div class="last">Last Seen:<br>{{ m.last_seen or '‚Äî' }}</div>
        <div class="actions">
            <a class="btn logs" href="/user-logs/{{ m.imei }}">üìú Logs</a>
        </div>
    </div>
    {% endfor %}
{% endfor %}
</div>

</div>

<script>
const sidebar=document.getElementById("sidebar");
function toggleSidebar(){
    const mobile=window.innerWidth<=768;
    if(mobile){
        sidebar.classList.toggle("hidden");
    }else{
        sidebar.classList.toggle("collapsed");
        document.body.classList.toggle("collapsed");
    }
}
if(window.innerWidth<=768){ sidebar.classList.add("hidden"); }
</script>

</body>
</html>
